#!/bin/bash

# 定义颜色 (用于非图形化提示)
GREEN=$(printf '\033[0;32m')
RED=$(printf '\033[0;31m')
NC=$(printf '\033[0m')

# 检查环境并确保 newt (whiptail) 已安装
if ! command -v whiptail >/dev/null 2>&1; then
    apk add --no-cache newt >/dev/null 2>&1
fi

# --- 子功能：网络设置菜单 ---
submenu_network() {
    while true; do
        SUB_CHOICE=$(whiptail --title "网络设置" --backtitle "R3S 管理系统" \
            --menu "请选择上网模式:" 15 60 4 \
            "1" "切换为 PPPoE 拨号模式" \
            "2" "切换为 动态 IP (DHCP) 模式" \
            "3" "手动配置上游 DNS" \
            "B" "返回主菜单" 3>&1 1>&2 2>&3)

        case "$SUB_CHOICE" in
            1|2)
                # 调用你之前的 network-setup.sh
                network-setup
                whiptail --title "完成" --msgbox "网络模式已更新！" 8 40
                ;;
            3)
                NEW_DNS=$(whiptail --inputbox "请输入 DNS (用空格分隔):" 8 60 "223.5.5.5 119.29.29.29" 3>&1 1>&2 2>&3)
                if [ -z "$NEW_DNS" ]; then
                    whiptail --title "取消" --msgbox "未修改任何设置。" 8 40
                else
                    set-dns $NEW_DNS
                    whiptail --title "完成" --msgbox "DNS 已更新为: $NEW_DNS" 8 60
                fi
                ;;
            *) break ;;
        esac
    done
}

# --- 子功能：广告拦截管理 ---
submenu_adblock() {
    while true; do
        SUB_CHOICE=$(whiptail --title "广告拦截管理" --backtitle "R3S 管理系统" \
            --menu "当前规则数: $(grep -c "address=/" /etc/dnsmasq.d/90-adblock.conf 2>/dev/null || echo 0)" 15 60 3 \
            "1" "立即更新广告屏蔽列表 (下载新规则)" \
            "2" "清空所有广告规则" \
            "B" "返回主菜单" 3>&1 1>&2 2>&3)

        case "$SUB_CHOICE" in
            1)
                # 调用 update-adblock.sh，并获取结果
                /usr/local/bin/update-adblock | whiptail --title "正在更新" --gauge "请稍后，正在下载并重载 DNS..." 6 60 0
                whiptail --title "成功" --msgbox "广告列表已更新并生效。" 8 40
                ;;
            2)
                if whiptail --title "确认" --yesno "确定要清空所有屏蔽规则吗？" 8 40; then
                    echo "" > /etc/dnsmasq.d/90-adblock.conf
                    killall -SIGHUP dnsmasq
                    whiptail --msgbox "规则已清空。" 8 40
                fi
                ;;
            *) break ;;
        esac
    done
}

# --- 主菜单 ---
main_menu() {
    while true; do
        # 获取一些实时数据用于显示
        TEMP=$(cut -c1-2 /sys/class/thermal/thermal_zone0/temp 2>/dev/null || echo "??")
        MEM=$(free -m | awk '/Mem:/ {printf "%d/%dMB", $3, $2}')

        CHOICE=$(whiptail --title "R3S 管理面板 (Alpine Linux)" \
            --backtitle "系统温度: ${TEMP}°C | 内存: ${MEM} | 开发者: allenmagic" \
            --menu "请使用方向键导航:" 18 65 8 \
            "1" "网络初始化与上网模式" \
            "2" "广告拦截 (AdBlock) 管理" \
            "3" "代理分流 (Nftset) 管理" \
            "4" "局域网在线设备扫描" \
            "5" "查看系统实时日志" \
            "S" "保存更改到 SD 卡 (LBU COMMIT)" \
            "X" "退出到命令行 (Shell)" \
            "Q" "退出并关闭连接" 3>&1 1>&2 2>&3)

        case "$CHOICE" in
            1) submenu_network ;;
            2) submenu_adblock ;;
            3) proxy show; read -p "按回车继续..." ;; # 也可以按此模式写子菜单
            4) client-mgr; read -p "按回车继续..." ;;
            5) logread -f ;;
            [sS])
                # 持久化操作
                if whiptail --title "持久化保存" --yesno "这将把当前所有配置写入 SD 卡，确保重启不丢失。继续？" 10 60; then
                    lbu commit -df
                    whiptail --msgbox "保存成功！" 8 40
                fi
                ;;
            [xX])
                clear
                echo -e "${GREEN}已切换到 Shell 模式。输入 'menu' 可重新进入管理界面。${NC}"
                break 2 # 跳出循环并结束脚本
                ;;
            [qQ])
                clear
                echo "连接已断开。"
                exit 0
                ;;
            *) exit 0 ;;
        esac
    done
}

# 执行主菜单
main_menu