#!/bin/bash

# Copyright (c) 2025 allenmagic
# Author: allenmagic
# License: MIT

set -euo pipefail

# 颜色定义
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# R3S 网口定义
WAN_IF="eth0"
LAN_IF="eth1"

# ==================== 通用函数 ====================

# 更新 nftables 变量
update_nft_vars() {
    local wan_dev="$1"
    mkdir -p /etc/nftables.d
    cat <<EOF > /etc/nftables.d/inet-vars.nft
define WAN = $wan_dev
define LAN = $LAN_IF
define WG = wg0
define TS = tailscale0
EOF
    echo -e "${GREEN}[配置] nftables 变量已更新: WAN=$wan_dev${NC}"
}

# 网络连通性检测
check_online() {
    echo -e "${YELLOW}正在验证互联网连接 (Ping 223.5.5.5)...${NC}"
    sleep 3
    if ping -c 3 -W 5 223.5.5.5 > /dev/null 2>&1; then
        echo -e "${GREEN}[成功] 互联网访问正常！${NC}"
        return 0
    else
        echo -e "${RED}[失败] 无法访问外网${NC}"
        return 1
    fi
}

# 重启网络服务
restart_network() {
    echo -e "${YELLOW}重启网络服务中...${NC}"
    rc-service networking restart
}

# 停止 PPPoE 拨号
stop_pppoe() {
    rc-service ppp.wan stop >/dev/null 2>&1 || true
    rc-update del ppp.wan default >/dev/null 2>&1 || true
    killall pppd >/dev/null 2>&1 || true
}

# ==================== 模式 1: DHCP 模式 ====================
setup_dhcp() {
    echo -e "${YELLOW}正在配置 DHCP 模式...${NC}"

    # 写入 interfaces 配置
    cat <<EOF > /etc/network/interfaces
auto lo
iface lo inet loopback

auto $WAN_IF
iface $WAN_IF inet dhcp
    hostname alpine-router

auto $LAN_IF
iface $LAN_IF inet static
    address 192.168.8.1
    netmask 255.255.255.0
EOF

    update_nft_vars "$WAN_IF"
    stop_pppoe
    restart_network

    if check_online; then
        echo -e "${GREEN}[成功] DHCP 模式配置完成！${NC}"
        return 0
    else
        echo -e "${RED}[失败] 请检查与上级路由的连线${NC}"
        return 1
    fi
}

# ==================== 模式 2: PPPoE 模式 ====================
setup_pppoe() {
    local ppp_user="$1"
    local ppp_pass="$2"

    echo -e "${YELLOW}正在配置 PPPoE 拨号模式...${NC}"

    # 写入 interfaces 配置
    cat <<EOF > /etc/network/interfaces
auto lo
iface lo inet loopback

auto $WAN_IF
iface $WAN_IF inet manual
    pre-up ip link set dev $WAN_IF up

auto $LAN_IF
iface $LAN_IF inet static
    address 192.168.8.1
    netmask 255.255.255.0
EOF

    # 写入拨号账号密码
    cat <<EOF > /etc/ppp/chap-secrets
"$ppp_user" * "$ppp_pass"
EOF
    cp /etc/ppp/chap-secrets /etc/ppp/pap-secrets
    chmod 600 /etc/ppp/chap-secrets /etc/ppp/pap-secrets

    # 写入拨号配置
    cat <<EOF > /etc/ppp/peers/wan
plugin rp-pppoe.so $WAN_IF
user "$ppp_user"
persist
maxfail 0
holdoff 5
defaultroute
usepeerdns
noauth
nodeflate
nobsdcomp
unit 0
EOF

    update_nft_vars "ppp0"

    # 启动拨号
    rc-update add ppp.wan default >/dev/null 2>&1 || true
    restart_network
    killall pppd >/dev/null 2>&1 || true
    rc-service ppp.wan restart

    # 等待拨号成功
    echo -e "${YELLOW}等待运营商分配 IP (最多 30 秒)...${NC}"
    local success=0
    for i in {1..15}; do
        if ip addr show ppp0 > /dev/null 2>&1; then
            local wan_ip
            wan_ip="$(ip addr show ppp0 | grep "inet " | awk '{print $2}')"
            echo -e "${GREEN}[成功] 拨号已建立！获取到 IP: $wan_ip${NC}"
            success=1
            break
        fi
        echo -n "."
        sleep 2
    done
    echo ""

    if [ $success -eq 1 ]; then
        if check_online; then
            return 0
        else
            echo -e "${RED}[异常] 拨号成功但无法访问外网，请检查 nftables 规则${NC}"
            return 1
        fi
    else
        echo -e "${RED}[错误] 拨号失败！${NC}"
        echo -e "${YELLOW}拨号日志摘要:${NC}"
        logread | grep pppd | tail -n 5
        return 1
    fi
}

# ==================== 模式 3: 静态 IP 模式 ====================
setup_static() {
    local static_ip="$1"
    local static_mask="$2"
    local static_gw="$3"
    local static_dns="$4"

    echo -e "${YELLOW}正在配置静态 IP 模式...${NC}"

    # 写入 interfaces 配置
    cat <<EOF > /etc/network/interfaces
auto lo
iface lo inet loopback

auto $WAN_IF
iface $WAN_IF inet static
    address $static_ip
    netmask $static_mask
    gateway $static_gw
    dns-nameservers $static_dns

auto $LAN_IF
iface $LAN_IF inet static
    address 192.168.8.1
    netmask 255.255.255.0
EOF

    update_nft_vars "$WAN_IF"
    stop_pppoe
    restart_network

    if check_online; then
        echo -e "${GREEN}[成功] 静态 IP 模式配置完成！${NC}"
        return 0
    else
        echo -e "${RED}[失败] 请检查 IP 配置是否正确${NC}"
        return 1
    fi
}

# ==================== 交互式主菜单 ====================
interactive_menu() {
    echo -e "${GREEN}==============================================${NC}"
    echo -e "${GREEN}      Alpine Router 网络初始化工具          ${NC}"
    echo -e "${GREEN}==============================================${NC}"
    echo "1) DHCP 模式 (上级路由/光猫自动获取 IP)"
    echo "2) PPPoE 拨号模式 (路由器直接拨号)"
    echo "3) 静态 IP 模式 (手动配置 IP 地址)"
    read -rp "请选择上网模式 [1-3]: " mode

    case "$mode" in
        1)
            setup_dhcp
            ;;
        2)
            local ppp_user ppp_pass
            while [ -z "${ppp_user:-}" ]; do
                read -rp "请输入拨号账号: " ppp_user
            done
            while [ -z "${ppp_pass:-}" ]; do
                read -rsp "请输入拨号密码: " ppp_pass
                echo ""
            done
            setup_pppoe "$ppp_user" "$ppp_pass"
            ;;
        3)
            local static_ip static_mask static_gw static_dns
            read -rp "请输入 WAN 口 IP 地址 (如 192.168.1.100): " static_ip
            read -rp "请输入子网掩码 (如 255.255.255.0): " static_mask
            read -rp "请输入网关地址 (如 192.168.1.1): " static_gw
            read -rp "请输入 DNS 服务器 (如 223.5.5.5): " static_dns
            setup_static "$static_ip" "$static_mask" "$static_gw" "$static_dns"
            ;;
        *)
            echo -e "${RED}无效选择${NC}"
            exit 1
            ;;
    esac

    echo -e "${GREEN}==============================================${NC}"
    echo -e "${YELLOW}请确认上网正常后，执行 '${GREEN}lbu commit -d${YELLOW}' 保存配置！${NC}"
    echo -e "${GREEN}==============================================${NC}"
}

# ==================== 主程序入口 ====================
# 支持两种调用方式：
# 1. 直接运行：显示交互式菜单
# 2. 函数调用：setup_dhcp / setup_pppoe / setup_static

if [ "${1:-}" = "dhcp" ]; then
    setup_dhcp
elif [ "${1:-}" = "pppoe" ]; then
    setup_pppoe "${2:-}" "${3:-}"
elif [ "${1:-}" = "static" ]; then
    setup_static "${2:-}" "${3:-}" "${4:-}" "${5:-}"
else
    interactive_menu
fi
