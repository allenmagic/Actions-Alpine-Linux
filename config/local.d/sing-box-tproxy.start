#!/bin/sh

# 1. 开启内核转发（兜底）
sysctl -w net.ipv4.ip_forward=1
sysctl -w net.ipv4.conf.all.rp_filter=0

# 2. 清理旧规则（防止重复执行报错）
ip rule del fwmark 1 table 100 2>/dev/null
ip route del local default dev lo table 100 2>/dev/null

# 3. 创建 TProxy 路由策略
ip route add local default dev lo table 100
ip rule add fwmark 1 table 100

# 4. 确保 LAN 网卡的 rp_filter 关闭（假设是 eth0，请根据实际修改）
# 这一步非常重要，否则 TProxy 的回包会被内核当作伪造包丢弃
echo 0 > /proc/sys/net/ipv4/conf/all/rp_filter