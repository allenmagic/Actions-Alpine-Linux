#!/bin/sh

# --- æ ¸å¿ƒé…ç½® ---
WAN_IF="eth0"
LAN_IF="eth1"
LAN_IP="192.168.8.1"

echo "Checking system health..."

# 1. æ£€æŸ¥ IP è½¬å‘å¼€å…³ (å†…æ ¸çº§ä¿åº•ï¼Œä¸å½±å“é˜²ç«å¢™è§„åˆ™)
if [ "$(cat /proc/sys/net/ipv4/ip_forward)" = "0" ]; then
    echo "è¡¥æ•‘: å¼€å¯å†…æ ¸ IP è½¬å‘"
    echo 1 > /proc/sys/net/ipv4/ip_forward
fi

# 2. WAN å£çŠ¶æ€æŽ¢æµ‹
# å¦‚æžœæ£€æµ‹åˆ°å·²ç»èŽ·å–äº† IPï¼Œè¯´æ˜Ž udhcpc æˆ–é™æ€é…ç½®å·²ç”Ÿæ•ˆï¼Œç›´æŽ¥è·³è¿‡
if ip addr show "$WAN_IF" | grep -q "inet "; then
    echo "âœ… WAN æŽ¥å£å·²å°±ç»ª"
else
    echo "âŒ WAN æŽ¥å£æœªå¯åŠ¨ï¼Œå°è¯•ç´§æ€¥èŽ·å– IP..."
    udhcpc -i "$WAN_IF" -n -q -t 5
fi

# 3. LAN å£çŠ¶æ€æŽ¢æµ‹
# å¦‚æžœ LAN å£å·²æœ‰ IP åœ°å€ï¼Œè¯´æ˜Ž interfaces é…ç½®æˆåŠŸï¼Œè·³è¿‡
if ip addr show "$LAN_IF" | grep -q "inet "; then
    echo "âœ… LAN æŽ¥å£ IP å·²é…ç½®"
else
    echo "âŒ LAN æŽ¥å£æ—  IPï¼Œå¼ºåˆ¶ç»‘å®šç´§æ€¥åœ°å€ $LAN_IP"
    ip addr add "$LAN_IP/24" dev "$LAN_IF" 2>/dev/null
    ip link set "$LAN_IF" up
fi

# 4. DNSMasq (DHCP) çŠ¶æ€æŽ¢æµ‹
# é¦–å…ˆåˆ¤æ–­æœåŠ¡æ˜¯å¦å·²ç»åœ¨æ­£å¸¸è¿è¡Œ
if rc-service dnsmasq status >/dev/null 2>&1; then
    echo "âœ… dnsmasq æœåŠ¡è¿è¡Œæ­£å¸¸"
else
    echo "âŒ dnsmasq æœªå¯åŠ¨ï¼Œå°è¯•é‡æ–°å¯åŠ¨æ­£å¼æœåŠ¡..."
    rc-service dnsmasq restart
    
    # å¦‚æžœé‡å¯åŽè¿˜æ˜¯æ²¡èµ·æ¥ï¼ˆè¯´æ˜Žé…ç½®æ–‡ä»¶æœ‰ç¡¬ä¼¤ï¼‰ï¼Œæ‰§è¡Œåº”æ€¥ DHCP
    sleep 2
    if ! pgrep dnsmasq >/dev/null; then
        echo "ðŸš¨ é…ç½®æ–‡ä»¶é”™è¯¯ï¼å¯åŠ¨åº”æ€¥ä¸´æ—¶ DHCP æ¨¡å¼..."
        dnsmasq --interface="$LAN_IF" \
                --dhcp-range=192.168.1.100,192.168.1.200,12h \
                --conf-file=/dev/null
    fi
fi

# 5. NFTables (é˜²ç«å¢™) çŠ¶æ€æŽ¢æµ‹
# å¦‚æžœæœåŠ¡æ²¡èµ·æ¥ï¼Œå°è¯•å¯åŠ¨å®ƒã€‚
# æ³¨æ„ï¼šæˆ‘ä»¬ä¸è½»æ˜“å°è¯•â€œè¦†ç›–â€é˜²ç«å¢™è§„åˆ™ï¼Œå› ä¸ºè¿™æ¶‰åŠå®‰å…¨ã€‚
# ä»…ç¡®ä¿æœåŠ¡å°è¯•åŠ è½½ä½ çš„æ­£å¼é…ç½®ã€‚
if rc-service nftables status >/dev/null 2>&1; then
    echo "âœ… nftables æœåŠ¡è¿è¡Œæ­£å¸¸"
else
    echo "âŒ nftables æœªè¿è¡Œï¼Œå°è¯•åŠ è½½æ­£å¼è§„åˆ™..."
    rc-service nftables start
fi

# 6. SSHD å­˜æ´»æ£€æŸ¥ (ç¡®ä¿ä½ èƒ½è¿›åŽ»ä¿®)
if ! rc-service sshd status >/dev/null 2>&1; then
    rc-service sshd start
fi

echo "Health check finished."
