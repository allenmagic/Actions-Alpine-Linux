# nftables 防火墙策略 —— 设计说明头（HEADER）

版本：1.0  
状态：生产可用（Production）  
最近一次完整评审：2025-12-23  

---

## 1. 设计目的（Purpose）

本防火墙配置用于一台同时承担以下角色的路由器：

- 公网接入（WAN）
- 远程安全接入 / 异地互联（VPN）
- 本地高信任内网服务（LAN）

设计目标不是“规则越多越安全”，而是：

> **行为可预测、控制面最小暴露、长期可维护**

本 ruleset 被刻意设计为 **易读、可审计、可扩展**，  
而不是只对当前环境“刚好能跑”。

---

## 2. 信任模型总览（Trust Model）


### 信任等级说明

| 区域 | 信任级别 | 说明 |
|----|--------|----|
| WAN | 不可信 | 可能存在扫描、洪泛、异常流量 |
| VPN | 受控信任 | 已认证，但仍需边界控制 |
| LAN | 高信任 | 内部网络，受保护设备 |

---

## 3. 各区域语义定义

### 3.1 WAN（公网）

- 视为 **敌对网络**
- 不允许直接访问路由器管理面
- 仅放行必要的 ICMP 控制报文（限速）
- 启用多层防护：
  - SYN Flood 限速
  - 动态黑名单
  - 日志限速，避免反 DoS

---

### 3.2 VPN（受控内网扩展）

VPN 被视为 **受控的内网扩展区域**，而不是单纯的传输隧道。

VPN 的用途包括：

- 远程登录路由器进行管理（SSH）
- 安全访问 LAN 内服务
- VPN 客户端之间互访
- 异地局域网 Site‑to‑Site 组网

因此：

> ✅ VPN **允许主动访问** LAN 资源  
> ❌ VPN **不等同于 WAN**

---

### 3.3 LAN（本地内网）

- 最高信任区域
- 可主动访问任意区域（WAN / VPN）
- 不被默认暴露到公网
- 仅通过明确 DNAT 才对 WAN 开放服务

---

## 4. 控制面策略（INPUT 链）

### 允许的访问来源

| 来源 | 允许内容 |
|----|----------|
| LAN | SSH 管理、ICMP 排错、DHCP |
| VPN | SSH 管理 |
| WAN | ICMP 控制类（严格限速） |

### 设计原则

- 路由器管理面 **永不直接暴露给 WAN**
- ICMP 被视为 **网络控制平面流量**
- IPv4 / IPv6 语义对称，避免黑洞
- 在消耗路由资源之前完成洪泛抑制

---

## 5. 数据面策略（FORWARD 链）

### 核心路由关系

- LAN ↔ WAN：允许
- LAN ↔ VPN：允许
- VPN ↔ LAN：允许

所有转发流量依赖 conntrack 进行状态校验。

---

### wireguard和tailscale 处理原则

- 不通过传统 DNAT 方式进行处理
- 本路由器充当 wireguard 和 tailscale 的三级路由，直接路由 wg0 和 tailscale0
- 因此需要注意在 wireguard 中继服务器上需要允许内网网段，同样在本路由器的 wg0 中需要允许内网网段
- 配置如下：
  - R3S - AllowedIPs = 10.10.10.0/24, 192.168.8.0/24
  - Wireguard 服务器 - 10.10.10.0/24, 192.168.8.0/24

---

## 6. ICMP 策略

### IPv4 / IPv6 对称设计

放行以下 ICMP 类型：

- destination‑unreachable（含 PMTU）
- time‑exceeded
- parameter‑problem
- echo‑request / echo‑reply

WAN 方向 **限速**，LAN 方向 **不限制**。

---

### IPv6 邻居发现（ND）

以下报文 **永远不被限速**：

- Router Solicitation / Advertisement
- Neighbor Solicitation / Advertisement

这是保证 IPv6 网络稳定性的必要条件。

---

## 7. 日志策略（Logging Policy）

日志以 **观测与趋势判断** 为目的，而非取证。

- INPUT 丢弃：10 条 / 分钟
- FORWARD 丢弃：10 条 / 分钟
- OUTPUT 观察：5 条 / 分钟

日志不应成为性能瓶颈或攻击放大器。

---

## 8. 明确的非目标（Non‑Goals）

本防火墙 **不试图**：

- 在 LAN 内实施零信任微分段
- 进行深度包检测（DPI）
- 从连接方向推断“用户意图”
- 替代应用层的认证与授权机制

这些不属于网络边界防火墙的职责。

---

## 9. 扩展原则（Extension Guidelines）

如需扩展（如 DMZ / IoT / Guest 网络）：

- 明确新增区域，不复用现有信任语义
- 不在 FORWARD 中写依赖 NAT 状态的规则
- 保持“规则即文档”的可读性
- 若一条规则无法用本文件解释，其合理性应被质疑

---

## 10. 维护哲学（Maintenance Philosophy）

本规则集遵循以下原则：

> **今天正确的规则，五年后仍应是正确的。**

修改应当：

- 有明确动机
- 有注释和文档更新
- 尽量少、尽量稳

---
